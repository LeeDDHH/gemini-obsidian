# Next.jsにおけるパフォーマンスとスタイリングの実践

Next.jsは強力なフレームワークですが、そのポテンシャルを最大限に引き出すには、パフォーマンス最適化と、App Router環境における適切なスタイリング手法の理解が不可欠です。

## 1. パフォーマンス最適化

ウェブサイトの表示速度はユーザー体験に直結します。Next.jsが提供する機能を活用し、ボトルネックを解消することが重要です。

- **画像の最適化 (`next/image`)**:
  従来の`<img>`タグの代わりに`next/image`コンポーネントを使用することで、画像の自動リサイズ、フォーマット変換（WebPなど）、遅延読み込み（lazy loading）が行われ、画像関連の読み込み負荷を大幅に削減できます。

- **JavaScriptの遅延読み込み (`next/dynamic`)**:
  ページの初回表示に不要なコンポーネント（例: モーダルウィンドウ、トグルメニュー）を、`next/dynamic`を用いて動的にインポートします。これにより、初期バンドルサイズが減少し、ページの表示開始時間（First Contentful Paint）が向上します。

- **外部スクリプトの読み込み制御 (`next/script`)**:
  サードパーティ製のスクリプト（Google Analytics, チャットボットなど）は、`next/script`コンポーネントで読み込みタイミングを制御します。`strategy`プロパティ（`afterInteractive`, `lazyOnload`など）を適切に設定することで、ページのレンダリングをブロックすることなく、最適なタイミングでスクリプトを実行できます。

- **バンドルサイズの可視化**:
  `@next/bundle-analyzer`を導入し、どのライブラリやコンポーネントがバンドルサイズを肥大化させているかを定期的に分析します。これにより、不要な依存関係の削除や、より軽量な代替ライブラリへの移行といった具体的な改善策を講じることができます。

## 2. App Router環境でのCSS-in-JS (Emotion)

Next.jsのApp Routerは、デフォルトでReact Server Components (RSC) を採用しており、従来のCSS-in-JSライブラリ（Emotionなど）の利用には注意が必要です。

- **`'use client'` ディレクティブの必須性**:
  EmotionのようなCSS-in-JSライブラリは、実行時にスタイルを生成するため、クライアントサイドでの動作が前提となります。そのため、Emotionを使用するコンポーネント、またはそれをインポートする親コンポーネントのファイルの先頭に`'use client'`を記述し、クライアントコンポーネントとして明示的に指定する必要があります。

- **サーバーサイドレンダリング (SSR) の設定**:
  App RouterでEmotionのSSRを正しく機能させるには、一手間必要です。具体的には、抽出したCSSを`<head>`タグに挿入するための特別なレジストリコンポーネントを作成し、ルートレイアウト (`layout.tsx`) でラップする必要があります。これにより、サーバー側で生成されたスタイルが初期HTMLに含まれ、ページのちらつき（FOUC）を防ぎます。この設定は、公式ドキュメントやMUIのインテグレーションガイドで詳細な手順が提供されています。

これらの実践的な知識は、Next.jsを用いて高速でモダンなウェブアプリケーションを構築する上で、開発者が共通して直面する課題を解決するための鍵となります。

### 関連ノート
- [[Next.jsを使ったサイトの表示速度改善]]
- [[Next.jsのappディレクトリでMUIとEmotionを使ったSSR設定手順]]
- [[Next.js(App Router)の環境にEmotionを導入したときに躓いたこと]]
- [[Server Side Rendering - Emotion]]
