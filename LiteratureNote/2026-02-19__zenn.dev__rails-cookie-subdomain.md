---
type: literature
source_url: https://zenn.dev/mutao/articles/rails-cookie-domain-subdomain-sharing
source_title: 異なるサブドメイン間でセッションを共有する。Cookie Domain属性の設定
source_type: web
created_at: 2026-02-19
updated_at: 2026-02-19
has_transcript: false
transcript_lang: N/A
failure_reason: N/A
tags: [Rails, Cookie, セキュリティ, セッション, サブドメイン]
---

## TL;DR

- `auth.example.com` でログインしても `app.example.com` でセッションが維持されない問題の解決策
- RailsのSet-CookieヘッダーにDomain属性を指定することで複数サブドメイン間でCookie共有が可能
- `config/initializers/session_store.rb` に `domain: '.example.com'` を追加するだけ
- ただし広範囲のDomain設定はXSSリスクを高めるため最小限のドメイン指定を推奨

## 要約

著者 mutao がRailsでサブドメイン間のセッション共有を実装する方法を解説した記事。

### 問題

`auth.example.com` でログインした後、`app.example.com` にアクセスするとログイン状態が失われる。

**原因**: RailsのSet-CookieヘッダーにDomain属性が指定されていないと、CookieはHost-only cookieとなり発行元ドメインのみで有効。

### Cookie Domain属性の動作

| Domain指定 | 有効範囲 |
|---|---|
| 未指定 | 発行元ホストのみ（Host-only） |
| `.example.com` | `example.com` 配下の全サブドメイン |

### 解決策

`config/initializers/session_store.rb` を編集:
```ruby
Rails.application.config.session_store :cookie_store,
  key: '_session_id',
  domain: '.example.com'  # ← これを追加
```

### セキュリティ注意事項

- 広範囲Domain設定 → 配下の全サブドメインがCookieを共有
- いずれかのサブドメインにXSS脆弱性 → セッション盗聴リスクが増加
- **MDN推奨**: 可能な限り最も制限的なドメインを指定すること

## 核心ポイント

- **Host-only Cookie**: Domain未指定のデフォルト動作を理解することが重要
- **最小権限原則**: Cookieのスコープも最小限に設定する
- **マルチサービスアーキテクチャ**: auth + app をサブドメインで分ける設計でよく発生する問題

## 内 적용 아이디어

- マイクロサービスやBFF構成でauth / appを別サブドメインに分ける場合は最初から設計に組み込む
- フロントエンド(SPA) ↔ バックエンドAPI が別サブドメインの場合も同様の問題が起きる

---
*取得日: 2026-02-19 | ソース: zenn.dev | 著者: mutao*
